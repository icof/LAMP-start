# Workflow pour les tests unitaires PHPUnit
# ExÃ©cute automatiquement vos tests Ã  chaque modification

name: ğŸ§ª Tests unitaires

on:
  push:
    branches: [ main, develop ]  # Seulement sur ces branches
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    
    # Matrice de tests : teste avec plusieurs versions PHP
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
        
    # Nom affichÃ© dans l'interface GitHub
    name: Tests PHP ${{ matrix.php-version }}
    
    steps:
      - name: ğŸ“¥ RÃ©cupÃ©rer le code
        uses: actions/checkout@v4
        
      - name: ğŸ˜ Installer PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mysqli, pdo, pdo_mysql
          coverage: xdebug
          
      - name: ğŸ“¦ Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          
      - name: ğŸ› ï¸ Installer les dÃ©pendances
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-suggest
          else
            echo "âš ï¸ Pas de composer.json trouvÃ©"
          fi
          
      - name: ğŸ” VÃ©rification syntaxe
        run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
        
      - name: ğŸ§ª ExÃ©cuter les tests PHPUnit
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --testdox tests/
          else
            echo "âš ï¸ PHPUnit non installÃ©, tests ignorÃ©s"
          fi
          
      - name: ğŸ“Š GÃ©nÃ©rer rapport de couverture
        if: matrix.php-version == '8.3'  # Seulement pour PHP 8.3
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
          fi
          
      - name: ğŸ“¤ Uploader rapport couverture
        if: matrix.php-version == '8.3'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml

# Workflow pour les tests unitaires PHPUnit
# Exécute automatiquement vos tests à chaque modification

name: 🧪 Tests unitaires

on:
  push:
    branches: [ main, develop ]  # Seulement sur ces branches
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    
    # Matrice de tests : teste avec plusieurs versions PHP
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
        
    # Nom affiché dans l'interface GitHub
    name: Tests PHP ${{ matrix.php-version }}
    
    steps:
      - name: 📥 Récupérer le code
        uses: actions/checkout@v4
        
      - name: 🐘 Installer PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mysqli, pdo, pdo_mysql
          coverage: xdebug
          
      - name: 📦 Cache Composer
        uses: actions/cache@v3
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          
      - name: 🛠️ Installer les dépendances
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-suggest
          else
            echo "⚠️ Pas de composer.json trouvé"
          fi
          
      - name: 🔍 Vérification syntaxe
        run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
        
      - name: 🧪 Exécuter les tests PHPUnit
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --testdox tests/
          else
            echo "⚠️ PHPUnit non installé, tests ignorés"
          fi
          
      - name: 📊 Générer rapport de couverture
        if: matrix.php-version == '8.3'  # Seulement pour PHP 8.3
        run: |
          if [ -f vendor/bin/phpunit ]; then
            vendor/bin/phpunit --coverage-text --coverage-clover=coverage.xml
          fi
          
      - name: 📤 Uploader rapport couverture
        if: matrix.php-version == '8.3'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
